/**
 * @fileoverview Script to build our visitor keys based on TypeScript AST.
 *
 * Uses `get-keys-from-ts.js` to read the files and build the keys and then
 * merges them in alphabetical order of Node type before writing to file.
 *
 * @author Brett Zamir
 */

import fs from "fs";
import { alphabetizeKeyInterfaces, getKeysFromTsFile } from "./get-keys-from-ts.js";
import backwardCompatibleKeys from "./backward-compatible-keys.js";

const { promises: { writeFile } } = fs;

(async () => {
    const { keys, tsInterfaceDeclarations } = await getKeysFromTsFile("./node_modules/@types/estree/index.d.ts");
    const { keys: jsxKeys } = await getKeysFromTsFile(
        "./node_modules/@types/estree-jsx/index.d.ts",
        {
            supplementaryDeclarations: tsInterfaceDeclarations
        }
    );

    const mergedKeys = alphabetizeKeyInterfaces({ ...keys, ...jsxKeys, ...backwardCompatibleKeys });

    // eslint-disable-next-line no-console -- CLI
    console.log("keys", mergedKeys);

    writeFile(
        "./lib/visitor-keys.js",
        // eslint-disable-next-line indent -- Readability
`// DO NOT MODIFY - generated by ../tools/build-keys-from-ts.js

/** @typedef {${Object.keys(mergedKeys).map(key => JSON.stringify(key)).join(" | ")}} VisitorKeyTypes */

/** @typedef {Readonly<{ [type: string]: ReadonlyArray<string> }>} VisitorKeys */

const KEYS = /** @type {const} */ (/** @satisfies {VisitorKeys} */ (${JSON.stringify(mergedKeys, null, 4).replace(/"(.*?)":/gu, "$1:")}));

// Freeze the object values.
for (const value of Object.values(KEYS)) {
    Object.freeze(value);
}
Object.freeze(KEYS);

export default KEYS;
`
    );

})();
